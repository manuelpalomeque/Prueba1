<!DOCTYPE html>
<html>
<head>
    <title>Integration Example</title>
</head>
<body>
    <script 
        id="Microsoft_Omnichannel_LCWidget" 
        src="https://oc-cdn-public.azureedge.net/livechatwidget/scripts/LiveChatBootstrapper.js"
        data-app-id="70ec806d-33b3-433c-ae08-d1154e8f5d54" 
        data-lcw-version="prod" 
        data-org-id="e01710f5-3028-427e-a334-c25d52a4fb2f" 
        data-org-url="https://unqe01710f53028427ea334c25d52a4f-crm2.omnichannelengagementhub.com">
    </script>
    <script>
        window.addEventListener('load', () => {
            if (window.Microsoft && window.Microsoft.Omnichannel && window.Microsoft.Omnichannel.LiveChatWidget) {
                const signInIds = [];
                window.Microsoft.Omnichannel.LiveChatWidget.SDK.setBotAuthTokenProvider(async (botTokenUrl, callback) => {
                    const urlSearchParams = new URLSearchParams(botTokenUrl);
                    const signInId = urlSearchParams.get("state");

                    if (signInIds.includes(signInId)) { // Ignore authenticated sign-in cards
                        callback({show: false});  // Hide card
                        return;
                    }

                    signInIds.push(signInId);

                    const authUrl = "https://de0b7d9b3f0c4469bde5acbfc0d015.15.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr7d6_pruebaOmni/directline/token?api-version=2022-03-01-preview"; // Customer's Authentication API
                    try {
                        const authResponse = await fetch(authUrl, {method: "POST"});
                        const authData = await authResponse.json();  // Customer's Auth Token

                        console.log('Auth Response:', authData); // Debugging line

                        const data = {
                            token: authData.token
                        };

                        console.log('Token Data:', data); // Debugging line

                        const payload = {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(data)
                        };

                        console.log('Payload:', payload); // Debugging line

                        const botAuthResponse = await fetch(botTokenUrl, payload); // Posts Auth Token to Bot directly

                        console.log('Bot Auth Response:', botAuthResponse); // Debugging line

                        // Sign in through Bot is successful
                        if (botAuthResponse.status === 200) {
                            signInIds.push(signInId); // Track authenticated sign-in card
                            callback({show: false}); // Hide card
                            return;
                        }

                        if (botAuthResponse.status === 404 || botAuthResponse.status === 202) {
                            callback({show: false}); // Hide card
                            return;
                        } else {
                            console.error('Unexpected botAuthResponse status:', botAuthResponse.status); // Handle other statuses
                        }

                    } catch (error) {
                        console.error('Fetch error:', error); // Log any errors
                    }

                    callback({show: true});  // Show sign-in card by default
                });
            } else {
                console.error('Omnichannel LiveChatWidget SDK is not loaded.');
            }
        });
    </script>
</body>
</html>
