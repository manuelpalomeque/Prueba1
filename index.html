<!DOCTYPE html>
<html>
<head>
  <title>Integration Example</title>
</head>
<body>
  <script>
    var clientApplication;

    // Inicializa clientApplication
    (function() {
      var msalConfig = {
        auth: {
          clientId: 'b6dfb15f-e770-41a1-924d-81171a6e1f15',
          authority: 'https://login.microsoftonline.com/ec6e7548-fce3-4f44-966a-f47a0f125a81'
        },
        cache: {
          cacheLocation: 'localStorage',
          storeAuthStateInCookie: false
        }
      };

      if (!clientApplication) {
        clientApplication = new Msal.UserAgentApplication(msalConfig);
        console.log('clientApplication initialized');
      }
    })();

    // Función para manejar el inicio de sesión
    function onSignin(idToken) {
      let user = clientApplication.getAccount();
      if (user) {
        document.getElementById("userName").innerHTML = "Estas logueado como: " + user.name + " " + user;
        console.log('User details:', user);
        let requestObj1 = {
          scopes: ["user.read", 'openid', 'profile']
        };
        reload();
      } else {
        console.error('No user found in onSignin');
      }
    }

    // Función para manejar el clic en el botón de inicio de sesión
    function onSignInClick() {
      let requestObj = {
        scopes: ["user.read", 'openid', 'profile']
      };

      clientApplication.loginPopup(requestObj)
        .then(onSignin)
        .catch(function(error) {
          console.error('Login error:', error);
        });
    }

    // Función para obtener el URI del recurso OAuth
    function getOAuthCardResourceUri(activity) {
      if (activity &&
        activity.attachments &&
        activity.attachments[0] &&
        activity.attachments[0].contentType === 'application/vnd.microsoft.card.oauth' &&
        activity.attachments[0].content.tokenExchangeResource) {
        return activity.attachments[0].content.tokenExchangeResource.uri;
      }
      return null;
    }

    // Función para intercambiar el token de manera asíncrona
    function exchangeTokenAsync(resourceUri) {
      let user = clientApplication.getAccount();
      if (user) {
        let requestObj = {
          scopes: [resourceUri]
        };
        return clientApplication.acquireTokenSilent(requestObj)
          .then(function(tokenResponse) {
            return tokenResponse.accessToken;
          })
          .catch(function(error) {
            console.error('Token exchange error:', error);
          });
      } else {
        console.error('No user found for token exchange');
        return Promise.resolve(null);
      }
    }

    // Función para obtener JSON a partir de una URL
    async function fetchJSON(url, options = {}) {
      try {
        const res = await fetch(url, {
          ...options,
          headers: {
            ...options.headers,
            accept: 'application/json'
          }
        });

        if (!res.ok) {
          throw new Error(`Failed to fetch JSON due to ${res.status}`);
        }

        return await res.json();
      } catch (error) {
        console.error('Fetch JSON error:', error);
        throw error;
      }
    }

    // Función principal
    async function main() {
      try {
        var theURL = "https://de0b7d9b3f0c4469bde5acbfc0d015.15.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr7d6_pruebaOmni/directline/token?api-version=2022-03-01-preview";
        var userdetails = clientApplication.getAccount();
        if (userdetails) {
          var userId = clientApplication.account?.accountIdentifier != null ?
            ("You-customized-prefix" + clientApplication.account.accountIdentifier).substr(0, 64)
            : (Math.random().toString() + Date.now().toString()).substr(0, 64);

          const { token } = await fetchJSON(theURL);
          console.log('Direct Line token:', token);

          const directLine = window.WebChat.createDirectLine({ token });
          const store = WebChat.createStore({}, ({ dispatch }) => next => action => {
            const { type } = action;
            if (type === 'DIRECT_LINE/CONNECT_FULFILLED') {
              dispatch({
                type: 'WEB_CHAT/SEND_EVENT',
                payload: {
                  name: 'startConversation',
                  type: 'event',
                  value: { text: userdetails.name }
                }
              });
              return next(action);
            }
            if (type === 'DIRECT_LINE/INCOMING_ACTIVITY') {
              const activity = action.payload.activity;
              let resourceUri;
              if (activity.from && activity.from.role === 'bot' &&
                (resourceUri = getOAuthCardResourceUri(activity))) {
                exchangeTokenAsync(resourceUri).then(function(token) {
                  if (token) {
                    directLine.postActivity({
                      type: 'invoke',
                      name: 'signin/tokenExchange',
                      value: {
                        id: activity.attachments[0].content.tokenExchangeResource.id,
                        connectionName: activity.attachments[0].content.connectionName,
                        token
                      },
                      "from": {
                        id: userId,
                        name: clientApplication.account.name,
                        role: "user"
                      }
                    }).subscribe(
                      id => {
                        if (id === 'retry') {
                          return next(action);
                        }
                      },
                      error => {
                        console.error('Post activity error:', error);
                        return next(action);
                      }
                    );
                    return;
                  } else {
                    return next(action);
                  }
                });
              } else {
                return next(action);
              }
            } else {
              return next(action);
            }
          });

          const styleOptions = {
            hideUploadButton: true
          };

          window.WebChat.renderWebChat(
            {
              directLine: directLine,
              store,
              userID: userId,
              styleOptions
            },
            document.getElementById('webchat')
          );
        } else {
          console.error('User details not found in main');
        }
      } catch (error) {
        console.error('Main function error:', error);
      }
    }

    // Ejecuta la función principal y maneja errores
    main().catch(err => console.error("An error occurred in main: " + err));
  </script>

  <!-- Script del Live Chat -->
  <script 
    id="Microsoft_Omnichannel_LCWidget" 
    src="https://oc-cdn-public.azureedge.net/livechatwidget/scripts/LiveChatBootstrapper.js"
    data-app-id="70ec806d-33b3-433c-ae08-d1154e8f5d54" 
    data-lcw-version="prod" 
    data-org-id="e01710f5-3028-427e-a334-c25d52a4fb2f" 
    data-org-url="https://unqe01710f53028427ea334c25d52a4f-crm2.omnichannelengagementhub.com">
  </script>
</body>
</html>
